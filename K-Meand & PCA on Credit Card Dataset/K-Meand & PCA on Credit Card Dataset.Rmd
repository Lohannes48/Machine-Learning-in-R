---
title: "Your Document Title"
author: "Document Author"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

```{r}
library(dplyr)
library(FactoMineR)
```

```{r}
data <- read.csv("uci-default-of-credit-card-clients.csv", skip = 1)
head(data)
```

```{r}
data <- data %>%
  mutate(SEX = as.factor(SEX),
         EDUCATION = as.factor(EDUCATION),
         MARRIAGE = as.factor(MARRIAGE),
         PAY_0 = as.factor(PAY_0),
         PAY_2 = as.factor(PAY_2),
         PAY_3 = as.factor(PAY_3),
         PAY_4 = as.factor(PAY_4),
         PAY_5 = as.factor(PAY_5),
         PAY_6 = as.factor(PAY_6),
         default.payment.next.month = as.factor(default.payment.next.month))
```

This dataset contains research aimed at examining cases of loan repayment or customer defaults in Taiwan and comparing or classifying each borrower to the default into several classes (classes not specified).

Following are the details of the variables in the dataset:

- Limit_bal: Amount of credit granted (Taiwan dollars)

- Sex: Sex (1 = male; 2 = female)

- Education: Education (1 = graduate school; 2 = university; 3 = high school; 4 = other)

- Marriage: Marital status (1 = married; 2 = single; 3 = other)

- age: Age (years)

- pay_0 - pay_6: History of past payments (from April to September 2005)
  with details:
  -1 = pay on time;
  1 = late payment for one month;
  2 = late payment for two months;
  . . .;
  8 = payment delay of eight months;
  9 = late payment over nine months.
  
- Bill_amt1 - Bill_amt6: Number of billing statements (from April to September 2005)

- Pay_amt1 - Pay_amt6: Amount of previous payment (from April to September 2005)

# K-Means + PCA

In this case, the K-means and PCA methods are used to find the optimal 'K' used, and the PCA method is used to make a plot for further interpretation.

## K-Means

using the k-means method to classify data into clusters (using the 'elbow' and PCA methods to find the optimal 'K' used)

```{r}
data.num <- data %>%
  select(-c(SEX, EDUCATION, MARRIAGE, PAY_0, PAY_2, PAY_3, PAY_4, PAY_5, PAY_6,
            default.payment.next.month))
```

### Scaling

Scaling data on numeric characters in a dataset

```{r}
data.z <- scale(data.num)
```

### Elbow Method

use the 'elbow' and PCA methods to find the optimal 'K' used

```{r}
wss <- function(data, maxCluster = 9) {
    # Initialize within sum of squares
    SSw <- (nrow(data) - 1) * sum(apply(data, 2, var))
    SSw <- vector()
    set.seed(100)
    for (i in 2:maxCluster) {
        SSw[i] <- sum(kmeans(data, centers = i)$withinss)
    }
    plot(1:maxCluster, SSw, type = "o", xlab = "Number of Clusters", ylab = "Within groups sum of squares", pch=19)
}
```

```{r}
wss(data.z)
```

Notes: The optimal 'K' result is obtained from the 'Elbow' method, which is 4 Clusters

```{r}
set.seed(100)
# k-means with k=4.
data.km <- kmeans(data.z,4)
```
```{r}
data.km$totss
data.km$betweenss
data.km$tot.withinss
```

Interpretation:

- Total Sum of Square: 449985
- Between Sum of Square: 159407.3
- Between_SS / Total_SS = 35.4%
- Total Width Sum of Square: 290577.7

## PCA

Performing the PCA method, previously separating the data data with numerical characters and other characters

```{r}
data.num$clust <- as.factor(data.km$cluster)

data.pca <- data.num %>% 
  select(-ID)

head(data.pca)
```

```{r}
table(data.pca$clust)
```

Because 30,000 observations cannot be plotted all of them, samples from each cluster are taken to classify and conduct research on the behavior in each cluster (100 samples are taken per cluster):

```{r}
PCA.1 <- data.pca[data.pca$clust == 1,]
PCA.1 <- PCA.1[1:100,]

PCA.2 <- data.pca[data.pca$clust == 2,]
PCA.2 <- PCA.2[1:100,]

PCA.3 <- data.pca[data.pca$clust == 3,]
PCA.3 <- PCA.3[1:100,]

PCA.4 <- data.pca[data.pca$clust == 4,]
PCA.4 <- PCA.4[1:100,]
```

```{r}
PCA.sample <- rbind(PCA.1, PCA.2, PCA.3, PCA.4)

PCA.num <- PCA.sample %>% 
  select(-clust)

PCA.num <- scale(PCA.num)

dat.PCA <- PCA(PCA.num, graph = F)
```

Make a PCA plot:

```{r}
plot(dat.PCA, choix=c("ind"), label="none", col.ind = PCA.sample$clust)

legend("topright", levels(PCA.sample$clust), pch = 19, col = 1:4)
```

```{r}
plot(dat.PCA, choix="var", col.ind=PCA.sample$clust)
```

Interpretation:

(Information generated by both graphs is 55% (from PC1 and PC2), so the interpretation below can be concluded that only has a 55% validation or confidence level.

- From the Variable Factor Map (Var):
  1. Much information is obtained on the variable Bill_amt (1-6) or the number of user bills
  2. Bill_amt variable (1-6) or the number of user bills and Pay_amt variable (1-6) or total
     user payments tend to be uncorrelated (correlation 0), because of the direction of the
     arrowtend to be perpendicular

- From the Individuals Factor Map (Ind):
  1. Cluster 2 or red dots tend to be users who have bills and average amount of payment, 
     meaning that the user is regular in use credit card and regularly pay bills
  2. Cluster 4 or blue dot tends to be a user who is rarely used credit cards and rarely get 
     credit card bills
  3. Cluster 1 or black dot tends to be a user who uses a lot credit card, and tend to be 
     difficult to pay
  4. Cluster 3 or green dot tends to be a user who uses a lot credit card, and tend to be 
     regular in paying
  5. outliers are listed in the green spot which tends to be high on the use of credit cards 
     at 3rd month
  6. Outliers are listed at the green spot which tends to be high on the 2 nd month bill


# PCA Only

The k-mean + pca method will be compared with the PCA method

```{r}
PCA.sample2 <- PCA.sample %>% 
  select(-clust)

dat.pca2 <- prcomp(PCA.sample2, scale=T)
```

```{r}
summary(dat.pca2)
```

```{r}
fancy_biplot <- function(PC, x="PC1", y="PC2", colors=c('black', 'black', 'goldenrod4', 'dodgerblue4')) {
  # PC being a prcomp object
  library(ggplot2)
  data <- data.frame(obsnames=row.names(PC$x), PC$x)
  plot <- ggplot(data, aes_string(x=x, y=y)) + geom_text(alpha=.4, size=3, aes(label=obsnames), color=colors[1])
  plot <- plot + geom_hline(aes(yintercept=0), size=.2) + geom_vline(aes(xintercept=0), size=.2, color=colors[2])
  datapc <- data.frame(varnames=rownames(PC$rotation), PC$rotation)
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  plot <- plot + coord_equal() + geom_text(data=datapc, aes(x=v1, y=v2, label=varnames), size = 5, vjust=1, color=colors[3])
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2), arrow=arrow(length=unit(0.2,"cm")), alpha=0.75, color=colors[4])
  plot
}
```

```{r}
biplot(dat.pca2)
```

Interpretation:

(Information generated by both graphs is 55% (from PC1 and PC2), so the interpretation below can be concluded as having only a 53% validation or confidence level.

- Bill_amt variable (1-6) or the number of user bills and Pay_amt variable (1-6) or total
  user payments tend to be uncorrelated (correlation 0), because of the direction of the 
  arrow tend to be perpendicular
- User data collected tends to have average characteristics (there are several outlier on the
  number of bills and credit card usage)
- Much information is obtained on the variable Bill_amt (1-6) or the number of user bills


# Conclusion

The K-means + pca method compared to the pca method has a similar significance value



